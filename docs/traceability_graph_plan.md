# トレーサビリティグラフUI機能 実装計画

## 目標

タスクのトレーサビリティ（分割・統合の経緯、親子関係）をグラフ形式で視覚的に確認できるUIを提供します。Git履歴のような横方向のネットワーク図で、タスクの変遷を直感的に理解できるようにします。

## 機能要件

### 1. タスク詳細モーダル内のグラフタブ

**目的**: タスクの直接的な関連性を素早く確認

**仕様**:
- タスク詳細モーダルに新しいタブ「グラフ」を追加
- 選択したタスクとその**直接の関連タスク**のみを表示
  - 親タスク（分割元）
  - 子タスク（分割先）
  - 統合元タスク
  - 統合先タスク
- 左から右への横方向レイアウト
- ノードクリックでそのタスクの詳細を開く
- コンパクトな表示（モーダル内に収まるサイズ）

**ユーザー価値**: タスクの文脈を素早く把握できる

### 2. 専用グラフビュー

**目的**: 特定のタスクに関連するすべてのタスクを詳細に確認

**仕様**:
- 新しいビュー/ページとして実装
- 選択したタスクから辿れる**すべての関連タスク**を再帰的に表示
- 広いスペースで詳細なグラフ表示
- 左から右への横方向レイアウト
- ズーム、パン機能
- ノードクリックでタスク詳細を開く
- ミニマップ表示（全体の位置を把握）

**ユーザー価値**: タスクの完全な変遷履歴を把握できる

### 3. メイン画面のグラフ表示

**目的**: プロジェクト全体のタスク構造を俯瞰

**仕様**:
- メイン画面に新しいビューとして追加（カンバンビューと並列）
- **すべてのタスク**の関係性を表示
- 初期状態では表示期間を限定（例: 直近30日間）
- ユーザーが表示期間を任意に変更可能（日付ピッカー）
- 左から右への横方向レイアウト
- ズーム、パン機能
- ノードクリックでタスク詳細を開く
- フィルタリング機能（ステータス、優先度、タグ）

**ユーザー価値**: プロジェクト全体の構造と進捗を一目で把握できる

## 技術仕様

### グラフライブラリ: React Flow

**選定理由**:
- React専用で統合が容易
- 優れた視認性とパフォーマンス
- カスタマイズ性が高い
- 横方向レイアウトのサポート
- ズーム、パン、ミニマップなどの機能が標準搭載
- アクティブなコミュニティとドキュメント

### グラフレイアウト

**方向**: 左から右（LR: Left to Right）

**ノードの配置**:
- 時系列順に左から右へ配置
- 親タスクが左、子タスクが右
- 統合の場合は複数のノードが1つに収束

**ノードのデザイン**:
- タスクタイトル
- ステータスバッジ（色分け）
- 優先度インジケーター
- アイコン（分割、統合を示す）

**エッジ（線）のデザイン**:
- 分割: 実線、矢印
- 統合: 実線、矢印
- 色分け（関係性のタイプ別）

### データフロー

1. **グラフデータの生成**:
   - タスクデータと履歴データから関係性を抽出
   - React Flowの形式（nodes, edges）に変換
   - レイアウトアルゴリズムを適用

2. **インタラクション**:
   - ノードクリック → タスク詳細モーダルを開く
   - ズーム/パン → グラフの表示範囲を調整
   - フィルタリング → 表示するタスクを絞り込み

## 実装するファイル

### カスタムフック

#### [NEW] [useTaskGraph.ts](file:///c:/Users/yoichi/.gemini/antigravity/scratch/chronicle/src/hooks/useTaskGraph.ts)
- タスクデータからグラフデータ（nodes, edges）を生成
- 3つのモード（direct, recursive, all）をサポート
- 表示期間フィルタリング

### コンポーネント

#### [NEW] [TaskGraph.tsx](file:///c:/Users/yoichi/.gemini/antigravity/scratch/chronicle/src/components/TaskGraph.tsx)
- React Flowを使用したグラフ表示コンポーネント
- カスタムノードコンポーネント
- カスタムエッジコンポーネント
- ズーム、パン、ミニマップ機能

#### [NEW] [GraphView.tsx](file:///c:/Users/yoichi/.gemini/antigravity/scratch/chronicle/src/components/GraphView.tsx)
- 専用グラフビュー（モード2）
- ツールバー（ズーム、フィルター）
- タスク選択UI

#### [NEW] [MainGraphView.tsx](file:///c:/Users/yoichi/.gemini/antigravity/scratch/chronicle/src/components/MainGraphView.tsx)
- メイン画面のグラフビュー（モード3）
- 期間選択UI
- フィルタリングUI

#### [MODIFY] [TaskDetailModal.tsx](file:///c:/Users/yoichi/.gemini/antigravity/scratch/chronicle/src/components/TaskDetailModal.tsx)
- 新しいタブ「グラフ」を追加
- `TaskGraph`コンポーネントを統合（directモード）

#### [MODIFY] [App.tsx](file:///c:/Users/yoichi/.gemini/antigravity/scratch/chronicle/src/App.tsx)
- グラフビューへのナビゲーション追加
- ビュー切り替え機能

## 非機能要件

### パフォーマンス
- 100タスクまで快適に表示
- 仮想化でノード数が多い場合も対応
- レイアウト計算の最適化

### ユーザビリティ
- 直感的な操作（ドラッグ、ズーム）
- レスポンシブデザイン
- ローディング状態の表示

### デザイン
- 既存のデザインシステムを使用
- プレミアムな見た目
- アニメーション（ノード追加時など）

## 実装の優先順位

### フェーズ1: 基本機能（MVP）
1. React Flowのインストールと基本セットアップ
2. `useTaskGraph`フックの実装（directモード）
3. `TaskGraph`コンポーネントの実装
4. タスク詳細モーダルへの統合

### フェーズ2: 専用ビュー
5. `useTaskGraph`のrecursiveモード実装
6. `GraphView`コンポーネントの実装
7. ナビゲーションの追加

### フェーズ3: メイン画面グラフ
8. `useTaskGraph`のallモード実装
9. 期間フィルタリング機能
10. `MainGraphView`コンポーネントの実装

## 検証計画

### 手動検証

1. **モーダル内グラフ**:
   - タスク詳細を開き、グラフタブを確認
   - 直接の関連タスクが正しく表示されることを確認
   - ノードクリックで別のタスク詳細が開くことを確認

2. **専用グラフビュー**:
   - グラフビューを開き、すべての関連タスクが表示されることを確認
   - ズーム、パン機能が動作することを確認
   - 複雑な関係性（分割→統合→分割など）が正しく表示されることを確認

3. **メイン画面グラフ**:
   - すべてのタスクが表示されることを確認
   - 期間フィルタリングが動作することを確認
   - パフォーマンスが許容範囲内であることを確認

### ブラウザテスト

Antigravityのブラウザツールで実際の操作をテストします。

## 今後の拡張可能性

- グラフのエクスポート（PNG、SVG）
- タスクの直接編集（グラフ上でドラッグして関係性を変更）
- アニメーション（タスクの変遷を時系列で再生）
- 異なるレイアウトアルゴリズム（ツリー、放射状など）
